<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    è®¡ç®—æœº | ç¥è›‹æ‚è°ˆ
</title>
<link rel="shortcut icon" href="https://lwhile.github.io/favicon.ico?v=1576339500229">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://lwhile.github.io/styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://lwhile.github.io/media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://lwhile.github.io">
                <img class="avatar" src="https://lwhile.github.io/images/avatar.png?v=1576339500229" alt="">
            </a>
            <div class="site-title">
                <h1>
                    ç¥è›‹æ‚è°ˆ
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    é¦–é¡µ
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    å½’æ¡£
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    æ ‡ç­¾
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    å…³äº
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-container main-container">
                <div id="content" class="main-container-left">
                    
    <div class="i-card">
        <b>æ ‡ç­¾ï¼š#
        è®¡ç®—æœº</b>
    </div>
    
        
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://lwhile.github.io/post/for-developer">
                        è‡´å¼€å‘äººå‘˜
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-11-06</time>
                    
                        <a href="https://lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-other_4">
            #è®¡ç®—æœº
        </a>
                        
                </div>
                <div class="post-article">
                    
                        <a href="https://lwhile.github.io/post/for-developer" class="post-feature-image" style="background-image:url(https://lwhile.github.io/post-images/for-developer.jpg) ">
                        </a>
                        
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            ã€Œè½¯æŠ€èƒ½:ä»£ç ä¹‹å¤–çš„ç”Ÿå­˜æŒ‡å—ã€åœ¨å¼€å¤´éƒ¨åˆ†æœ‰å‡ å¥è¯,æˆ‘çœ‹äº†ä¹‹åè§‰å¾—å¾ˆæ£’,äºæ˜¯æ‘˜æŠ„ä¸‹æ¥æ¿€åŠ±è‡ªå·±.

è°¨ä»¥æœ¬ä¹¦çŒ®ç»™æ‰€æœ‰è‡ªå¼ºä¸æ¯,å­œå­œä¸å€¦åœ°æŒç»­è‡ªæˆ‘æ”¹è¿›çš„å¼€å‘äººå‘˜,ä»–ä»¬å…·å¤‡ä»¥ä¸‹ç´ è´¨:
æ°¸è¿œä¸ä¼šå¯¹&amp;quot;ä¸é”™&amp;quot;æ„Ÿåˆ°å¿ƒæ»¡æ„è¶³
æ°¸è¿œå¯»æ±‚æ¯ä¸€ä¸ªæœºä¼šæ¥æ‰©å±•è‡ªå·±çš„è§†é‡, æ¢ç´¢æœªçŸ¥äº‹ç‰©
å¯¹çŸ¥è¯†çš„æ¸´æ±‚æ°¸è¿œä¸ä¼šç†„ç­
ç¬ƒä¿¡è½¯ä»¶å¼€å‘å¹¶ä¸ä»…ä»…æ„å‘³ç€ç¼–å†™ä»£ç 
çŸ¥é“å¤±è´¥ä¸æ˜¯ç»“æŸ,å¤±è´¥åªæ˜¯äººç”Ÿæ—…é€”ä¸Šçš„å°å°ä¸€æ­¥
æœ‰è¿‡æŒ£æ‰,æœ‰è¿‡å¤±è´¥,ä½†ä»ç„¶ä¼šçˆ¬èµ·æ¥ç»§ç»­æˆ˜æ–—
æ‹¥æœ‰å¼ºçƒˆæ„æ„¿å’Œå†³å¿ƒ,åœ¨äººç”Ÿçš„é“è·¯ä¸Šä¸ç•è‰°éš¾
ä»¥åŠæœ€é‡è¦çš„,æ„¿æ„ä¸€è·¯ä¸Šå¸®åŠ©ä»–äºº


                                        </div>
                                        
                                            <a class="btn btn-text" href="https://lwhile.github.io/post/for-developer">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://lwhile.github.io/post/go-timezone">
                        Go æ—¶åŒºç”¨æ³•æ€»ç»“
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2019-02-19</time>
                    
                        <a href="https://lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-error">
            #è®¡ç®—æœº
        </a>
                        
                        <a href="https://lwhile.github.io/tag/5UKnY2CH9d" class="post-tag i-tag
                            i-tag-other_3">
            #Go
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            åŠé—´æœ‰ä¸ªè¯´æ³•ï¼Œè¯´ä¸­ç¾ä¸¤å›½çš„ç¨‹åºå‘˜é™¤äº†è–ªèµ„ã€åŠ ç­å¼ºåº¦å¤–ï¼Œè¿˜æœ‰ä¸ªæ¯”è¾ƒæœ‰è¶£çš„å·®å¼‚ï¼Œå°±æ˜¯åœ¨ç¼–ç æ—¶å¯¹äºæ—¶åŒºçš„æ•æ„Ÿç¨‹åº¦ä¹Ÿä¸åŒã€‚
ã€Œå¤§éƒ¨åˆ†ã€ç¾å›½ç¨‹åºå‘˜åœ¨æ—¶åŒºé—®é¢˜ä¸Šå¾ˆæœ‰ç»éªŒï¼Œå› ä¸ºç¾å›½åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä¼šä½¿ç”¨åˆ° 3 ä¸ªæ—¶åŒºã€‚è€Œä¸­å›½ã€Œå¤§éƒ¨åˆ†ã€ç¨‹åºå‘˜åœ¨ç¼–ç æ—¶åŸºæœ¬ä¸ä¼šè€ƒè™‘æ—¶åŒºé—®é¢˜ï¼Œå› ä¸ºå¤§å®¶éƒ½åœ¨ä¸œå…«åŒºï¼Œæ²¡é‚£ä¸ªçƒ¦æ¼ã€‚
åœ¨è¿‡å»ä¸€å¹´æˆ‘ç»´æŠ¤ç€ä¸€ä¸ªå…¬å¸å†…éƒ¨çš„æ—¥å†åº“ï¼Œç”¨äºåšäº¤æ˜“æ—¶é—´çš„è®¡ç®—ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¢«æ—¶åŒºé—®é¢˜æŠ˜ç£¨å¾—å¾ˆéš¾å—ï¼Œä¸è¿‡ä¹Ÿç§¯ç´¯ä¸€äº› Go å¤„ç†æ—¶åŒºä¸Šçš„ç»éªŒã€‚
æ—¶åŒºé…ç½®
æ—¶åŒºçš„é…ç½®ä¸€å®šè¦å£°æ˜åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ç§ yaml æ ¼å¼ï¼š

timezone: Asia/Hong_Kong

åˆ«æƒ³ç€ç”¨æœºå™¨æ—¶åŒºä¸€åŠ³æ°¸é€¸è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæœºå™¨çš„å˜æ•°å¤ªå¤šäº†ã€‚
è½½å…¥æ—¶åŒº
åœ¨ Go ä¸­ï¼Œæ—¶åŒºè¢«å°è£…åœ¨ time.Location ä¸­è¿›è¡ŒæŠ½è±¡ï¼Œè€Œè½½å…¥æ—¶åŒºæœ‰ä¸¤ç§æ–¹æ³•

é€šè¿‡ IANA æ•°æ®åº“

ç»™ time.LoadLocation ä¼ å…¥ä¸€ä¸ªç¬¦åˆ IANA æ—¶åŒºæ•°æ®åº“çš„æ—¶åŒºåå­—ï¼Œæ¯”å¦‚ï¼š

Asia/Hong_Kong


é€šè¿‡åç§»é‡

time.FixedZone(&amp;quot;UTC-8&amp;quot;, -8 **60 **60)
è½¬æ¢æ—¶åŒº
æ¯”è¾ƒç®€å•çš„æ“ä½œï¼Œç›´æ¥è°ƒä¸€ä¸ª time struct instance çš„ In(*Location) æ–¹æ³•ã€‚
ä¿®æ”¹æ—¶åŒº
æ³¨æ„ä¿®æ”¹æ—¶åŒºå’Œè½¬æ¢æ—¶åŒºæ˜¯ä¸¤ç§ä¸åŒçš„æ¦‚å¿µã€‚
æ¯”å¦‚åŒ—äº¬æ—¶é—´ 20:00pm è½¬æ¢æ—¶åŒºï¼Œä»¥ç¾ä¸œæ—¶åŒºä¸ºä¾‹ï¼Œä¼šæ˜¯ 7:00am (å†¬ä»¤æ—¶)
è€Œä¿®æ”¹æ—¶åŒºæ˜¯æŒ‡æŠŠåŒ—äº¬ 20:00pm ä¿®æ”¹ä¸ºç¾ä¸œ 20:00pmï¼Œå¯ä»¥è¿™æ ·æ“ä½œï¼š

// Pseudo code
var estTime time.Time
var cstTime time.Time
var estTimezone *time.Location
// é€šè¿‡ time.Date æ–¹æ³•é‡æ–°ç”Ÿæˆä¸€ä¸ª time struct instance
estTime := time.Date(cstTime.Year(), cstTime.Month(),..., estTimezone)

Round to day
å®åœ¨æƒ³ä¸èµ·ä¸€ä¸ªåè¯å¯ä»¥å½¢å®¹ Round to day çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªæ–¹æ³•æ¥åšæ—¥å†…æ—¶é—´çš„æ¯”è¾ƒã€‚
æ¯”è¾ƒå…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯åˆ¤æ–­æ˜¯å¦åˆ°äº†å¼€å¸‚/ä¼‘å¸‚æ—¶é—´ã€‚ç”±äºåœ¨ Go ä¸­ time ç±»å‹æ˜¯åŒ…å«æœ‰å¹´ã€æœˆä¿¡æ¯çš„ï¼Œæ‰€ä»¥è¦è¡¨è¾¾ã€Œæ¯å¤©æ—©ä¸Š 9:30ã€ è¿™ä¸ªæ—¶é—´ä¸å¤§å¥½åšã€‚
æ—¢ç„¶ä¸å¥½åšï¼Œé‚£å°±æŠŠå®ƒä»¬å»æ‰ã€‚

// Pseudo code
func RoundToDay(t time.Time) time.Time {
// æ³¨æ„åœ¨ Go ä¸­ zero time å¹¶ä¸æ˜¯ 0 year 0 month 0 dayï¼Œè€Œæ˜¯ 1ï¼Œæ‰€ä»¥ç”¨ 0 çš„è¯ä¼šæº¢å‡ºå–”
return time.Date(1,1,t.Day(), t.Hour() ...)
}

LMT
LMT è¿™ä¸ªé—®é¢˜æ˜¯åœ¨ Round to day ä¸Šé¢å¼•å‘å‡ºæ¥çš„ï¼Œè¯´èµ·æ¥ä¹Ÿå¾ˆæœ‰è¶£ã€‚LMT æœ¬æ„æ˜¯æŒ‡ local mean timeï¼ˆåœ°æ–¹å¹³æ—¶ï¼Œåœ¨æŒ‡å®šçš„ç»åº¦èŒƒå›´å†…ä½¿ç”¨ä¸€è‡´æ—¶é—´çš„åœ°æ–¹å¤ªé˜³æ—¶ï¼‰ã€‚
å¦‚æœä½ ç”¨è¯•å›¾åœ¨ Go é‡Œé¢ç”¨é¦™æ¸¯æ—¶åŒºæ„å»ºä¸€ä¸ª zero time çš„è¯ï¼Œå°±ä¼šå‘ç°æœ€åè¿”å›å‡ºæ¥çš„ time struct instance çš„ location ä¿¡æ¯æ˜¯ LMTã€‚è¿™ä¸ªé—®é¢˜æ˜¯åœ¨ä¸€å¤„å•å…ƒæµ‹è¯•ä¸­å‘ç°çš„ï¼Œæ­»æ´»æ— æ³•é€šè¿‡æµ‹è¯•ï¼ˆå—¯ï¼Œå•æµ‹çœŸçš„å¾ˆé‡è¦ï¼‰ã€‚
ä¸è¿‡è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ
æˆ‘ç›¸ä¿¡çŸ¥é“è¿™ä¸ªçŸ¥è¯†ç‚¹çš„äººç»å¯¹å°‘ä¹‹åˆå°‘ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸å†·çš„çŸ¥è¯†ï¼ˆæœ€åé€šè¿‡æˆ‘é‚£ä½çŸ¥è¯†å‚¨å¤‡é‡éå¸¸ä¸°å¯Œçš„åŒäº‹çŸ¥é“çš„è¿™ä¸ªï¼‰

é¦™æ¸¯æ™‚é–“çš„æˆæ™‚æœå‹™ï¼Œæ˜¯é¦™æ¸¯å¤©æ–‡å°å¾1883å¹´æˆç«‹è‡³ä»Šçš„ä¸»è¦è·è²¬ã€‚æ—©æœŸé¦™æ¸¯å¤©æ–‡å°ä½¿ç”¨èµ¤é“å„€åŠä¸­æ˜Ÿå„€ï¼Œé€éè§€æ¸¬æ˜Ÿè±¡æ¸¬é‡æ™‚é–“ã€‚ç•¶æ™‚é¦™æ¸¯æ™‚é–“æ˜¯ç•¶åœ°å¹³å‡æ™‚é–“ï¼ˆLMTï¼‰UTC+7:36:42ï¼ˆæº–ç¢ºå€¼ç‚ºUTC+7:36:41.8842ï¼‰ã€‚é¦™æ¸¯å¤©æ–‡å°æœ€æ—©æ–¼1885å¹´1æœˆ1æ—¥å°å…¬çœ¾æˆæ™‚[1]ï¼Œç•¶å¹´é¦™æ¸¯å¤©æ–‡å°æ–¼ä¹é¾å°–æ²™å’€è­¦ç½²è¨­ç½®æ¡…æ†ï¼Œä»¥å‡é™æ™‚é–“çƒçš„æ–¹å¼å°å¤–ç™¼å¸ƒæ™‚é–“ã€‚1885å¹´1æœˆ1æ—¥ï¼Œé¦™æ¸¯å¤©æ–‡å°æ–¼ä¸­åˆ12æ™‚50åˆ†æŠŠæ™‚é–“çƒå‡åˆ°æ¡…æ†é ‚ç«¯ï¼Œç„¶å¾Œæ–¼ä¸‹åˆ1æ™‚æ­£ï¼Œé¦–æ¬¡æŠŠæ™‚é–“çƒé™ä¸‹ï¼Œæˆç‚ºé¦™æ¸¯é¦–æ¬¡å ±æ™‚è¨Šè™Ÿï¼Œä¸¦ä½œç‚ºé¦™æ¸¯æ™‚é–“çš„æ¨™æº–ã€‚ç”¨æ–¼å ±æ™‚çš„æ™‚é–“çƒè¨Šè™Ÿå¡”ï¼Œå¾Œä¾†æ–¼1933å¹´å› ç‚ºé›»å°å ±æ™‚çš„é–‹å±•è€Œæ‹†é™¤ã€‚1904å¹´10æœˆ30æ—¥ï¼Œé¦™æ¸¯æ™‚é–“æ­£å¼ç¢ºå®šç‚ºæ ¼æ—å¨æ²»æ¨™æº–æ™‚é–“å¿«8å°æ™‚ï¼ˆGMT+8ï¼‰[2]ã€‚2004å¹´ï¼Œå¤©æ–‡å°å®‰è£äº†ä¸€å¥—é«˜æº–ç¢ºåº¦æˆæ™‚ç³»çµ±ï¼Œåˆ©ç”¨å…¨çƒå®šä½ç³»çµ±å…±è¦–æ–¹æ³•ï¼Œå‘åœ‹éš›åº¦é‡è¡¡å±€æä¾›å¤©æ–‡å°çš„åŸå­é˜æ™‚é–“æ•¸æ“šï¼Œåƒèˆ‡è¨‚å®šå”èª¿ä¸–ç•Œæ™‚ã€‚å¤©æ–‡å°äº¦æ ¹æ“šåœ‹éš›åº¦é‡è¡¡å±€æä¾›çš„æ™‚é–“æ•¸æ“šèª¿æ ¡åŸå­é˜ï¼Œä½¿å…¶æº–ç¢ºåº¦ä¿æŒåœ¨ä¸€ç™¾è¬åˆ†ä¹‹ä¸€ç§’ä»¥å…§ã€‚ç¾æ™‚ï¼Œé¦™æ¸¯å¤©æ–‡å°ä»¥éŠ«åŸå­é˜å ±æ™‚ç³»çµ±ä½œç‚ºé¦™æ¸¯æ™‚é–“çš„æ¨™æº–ï¼Œèª¤å·®åƒ…ç‚ºæ¯æ—¥1å¾®ç§’ä¹‹å…§ã€‚é¦™æ¸¯å¤©æ–‡å°è¨­æœ‰äº’è¯ç¶²æ™‚é–“ä¼ºæœå™¨ï¼Œç‚ºäº’è¯ç¶²çš„ç”¨æˆ¶æä¾›æº–ç¢ºçš„æ™‚é–“æ ¡æ­£æœå‹™[3]ã€‚

æ ¹æ®ä¸Šé¢çš„è®°å½•æ¥çœ‹å‡ ä¸ªä¾‹å­å§ï¼Œé¦–å…ˆæ˜¯ 1904 å¹´ 10 æœˆ 30 æ—¥åé¦™æ¸¯ä½¿ç”¨ GMT+8ï¼Œæˆ‘ä»¬æŠŠæ—¶é—´å®šæ ¼åœ¨å®ƒå‰ä¸€ç§’ï¼š

location, _ := time.LoadLocation(&amp;quot;Asia/Hong_Kong&amp;quot;)

t := time.Date(1904,10,29,11,59,59,59,location)
fmt.Println(t) // 1904-10-29 11:59:59.000000059 +0736 LMT &amp;lt;- LMT æ— ç–‘
ç„¶åæ˜¯ 1904 å¹´ 10 æœˆ 30 æ—¥ é›¶ç‚¹ï¼š

location, _ := time.LoadLocation(&amp;quot;Asia/Hong_Kong&amp;quot;)

t := time.Date(1904,10,30,0,0,0,0,location)
fmt.Println(t) // 1904-10-30 00:23:18 +0800 HKT &amp;lt;- HKT äº†ã€‚
å‰å®³å§ã€‚ã€‚ã€‚è¿˜æœ‰æ›´å‰å®³çš„ã€‚ã€‚ã€‚

location, _ := time.LoadLocation(&amp;quot;Asia/Hong_Kong&amp;quot;)

t := time.Date(1942,10,30,0,0,0,0,location)
fmt.Println(t) // 1942-10-30 00:00:00 +0900 JST
ç”¨ 1942 å¹´ 10 æœˆ 30 æ—¥æ„å»ºä¸€ä¸ªé¦™æ¸¯æ—¶é—´ï¼Œæ—¶åŒºä¼šæ˜¯ï¼ˆJSTï¼‰æ—¥æœ¬æ ‡å‡†æ—¶é—´ã€‚Why?
åŸå› æ˜¯è¿™ä¸ªï¼š

é¦™æ¸¯æ—¥ä½”æ™‚æœŸï¼Œåˆç¨±ç‚ºé¦™æ¸¯æ—¥æ²»æ™‚æœŸæˆ–é¦™æ¸¯æ·ªé™·æ™‚æœŸï¼Œæ˜¯æŒ‡ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ°æ™‚å¤§æ—¥æœ¬å¸åœ‹è»äº‹å é ˜é¦™æ¸¯çš„æ™‚æœŸï¼šç”±1941å¹´12æœˆ25æ—¥é¦™æ¸¯ç¸½ç£æ¥Šæ…•ç¦æŠ•é™èµ·ï¼Œè‡³1945å¹´8æœˆ15æ—¥æ—¥æœ¬ç„¡æ¢ä»¶æŠ•é™ç‚ºæ­¢ï¼›é¦™æ¸¯äººä¿—ç¨±é€™æ®µæ™‚æœŸç‚ºã€Œä¸‰å¹´é›¶å…«å€‹æœˆã€ã€‚

åˆ«ä»¥ä¸º Go çš„å¼€å‘å›¢é˜Ÿè¿™ä¹ˆæœ‰å¿ƒï¼Œå®é™…ä¸Š Go ä¹Ÿæ˜¯è¯»æ“ä½œç³»ç»Ÿçš„ zoneinfo æ–‡ä»¶ã€‚åªèƒ½è¯´åœ¨æŸä¸ªå±‚é¢ä¸Šæ“ä½œç³»ç»Ÿä¹Ÿè®°å½•ç€æ¯ä¸ªåœ°åŒºçš„å†å²ã€‚ã€‚ã€‚

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://lwhile.github.io/post/go-timezone">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://lwhile.github.io/post/exponential-backoff">
                        æŒ‡æ•°é€€é¿
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2018-04-02</time>
                    
                        <a href="https://lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-other_1">
            #è®¡ç®—æœº
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            è¿™æ˜¯åŠ å…¥æ–°å…¬å¸åçš„ç¬¬ä¸€ç¯‡æŠ€æœ¯åšæ–‡ï¼Œä¸»è§’æ˜¯ä¸€ç§å«åšæŒ‡æ•°é€€é¿çš„ç®—æ³•ã€‚è¿˜æ˜¯æŒ‰ç…§ä»¥å¾€çš„æƒ¯ä¾‹ï¼Œè¿™ç¯‡æ–‡ç« ä¼šä»é—®é¢˜çš„å‘ç”Ÿè‡³é—®é¢˜çš„è§£å†³è®°ä¸€ä¸ªæµæ°´è´¦ã€‚
é—®é¢˜çš„åœºæ™¯å‘ç”Ÿä¸šåŠ¡ç³»ç»Ÿä¸­çš„ RPC è°ƒç”¨ä¸­ï¼Œéœ€æ±‚æ˜¯å¸Œæœ›å¦‚æœä¸€ä¸ª RPC è°ƒç”¨å¤±è´¥äº†ï¼Œèƒ½å¤Ÿè¿›è¡Œé‡è¯•ã€‚
ä½œä¸ºä¸€ä¸ªèœé¸Ÿï¼Œæˆ‘å¾ˆå¿«å†™å…¥äº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œç”¨ Go è¯­è¨€æè¿°å‡ºæ¥çš„é€»è¾‘å¦‚ä¸‹ï¼š
func retry(maxRetry int, f func() error) {
    for i:=0;i&amp;lt;maxRetry;i++ {
        err := f()
        if err == nil {
          return 
        }
    }
}

å¾ˆå¿«è¿™ç§ä»£ç åœ¨ review çš„æ—¶å€™å°±è¢«æ‰“ä¸‹æ¥äº†ã€‚ç†ç”±æ˜¯ä½œä¸ºç½‘ç»œè°ƒç”¨ï¼Œè¿™ç§é‡è¯•æœºåˆ¶æ˜¯ä¸åˆç†çš„ã€‚è¯•æƒ³ä»¥ä¸‹å¦‚æœæ˜¯é‡åˆ°æœºå™¨é‡å¯æˆ–è€…ç½‘ç»œæŠ–åŠ¨ï¼Œå¯¹æ–¹çš„æœåŠ¡è¦åœ¨ 1 åˆ†é’Ÿç”šè‡³æ›´ä¹…ä¹‹åæ‰èƒ½æ¢å¤æ­£å¸¸ï¼Œé‚£ä¹ˆå°†é‡è¯•æ”¾åœ¨ä¸€ä¸ªæ²¡æœ‰åœæ­‡çš„ for å¾ªç¯é‡Œé¢ï¼Œè¯•é”™çš„æœºä¼šå¾ˆå¿«å°±ä¼šè¢«ç”¨å®Œã€‚
mentor æç¤ºæˆ‘å¯ä»¥è¯•ä¸‹æŒ‡æ•°é€€é¿ç®—æ³•ï¼ˆexponential backoffï¼‰ï¼Œç½‘ä¸Šçœ‹äº†ä¸€äº›ç®—æ³•çš„ä»‹ç»ï¼Œå¾ˆå¿«å°±å†™äº†ç¬¬äºŒä¸ªç‰ˆæœ¬å‡ºæ¥ã€‚
é€»è¾‘è¿˜æ˜¯å·®ä¸å¤šï¼Œåªä¸è¿‡å¤šäº†ä¸€æ­¥ä¼‘çœ çš„æ“ä½œï¼š
func retry(maxRetry int, f func() error) {
    for i:=0;i&amp;lt;maxRetry;i++ {
        err := f()
        if err == nil {
          return 
        }
        // calculate the dynamic duration
        dur := call()

        time.Sleep(dur)
    }
}

ç®—æ³•çš„æ ¸å¿ƒåœ¨äºè®¡ç®—å‡ºé‡è¯•çš„é—´éš”ï¼Œå¦‚æœé‡è¯•å¤±è´¥ï¼Œé‚£ä¹ˆå°±è¦ç›¸åº”å¾—å»¶é•¿ä¸‹æ¬¡é‡è¯•çš„æ—¶é—´ã€‚
é‡è¯•é—´éš”è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š
sleep = min(cap, base * 2 ** attempt)
éšç€é‡è¯•æ¬¡æ•° attempt çš„å¢åŠ ï¼Œsleep çš„æ•°å€¼ä¼šå‡ºç°æŒ‡æ•°çº§çš„å˜åŒ–ã€‚
å¯¹äºä¸€äº›æœåŠ¡æ¯”å¦‚æ¶‰åŠåˆ°äº‹åŠ¡çš„æ•°æ®åº“æ“ä½œï¼Œå¦‚æœæœ‰å¤šä¸ª client åŒæ—¶ä½¿ç”¨ä¸Šé¢è¿™æ¡å…¬å¼çš„è¯ï¼Œä¼šå‡ºç°è¯·æ±‚æŒ¤å‹çš„æƒ…å†µå¯¼è‡´ç³»ç»Ÿçš„æ•´ä½“ååé‡ä¸‹é™ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªéšæœºå› å­é¿å…è¯¥é—®é¢˜ï¼Œç»è¿‡ä¿®æ”¹çš„å…¬å¼å¦‚ä¸‹ï¼š
sleep = random_between(0, min(cap, base * 2 ** attempt))
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Goï¼Œæ¨èä¸‹è¿™ä¸ªåº“ï¼šhttps://github.com/cenkalti/backoff

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://lwhile.github.io/post/exponential-backoff">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://lwhile.github.io/post/etcd-watch-source-code">
                        Etcd watchæºç é˜…è¯»
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2017-11-10</time>
                    
                        <a href="https://lwhile.github.io/tag/iYb5jfiTB" class="post-tag i-tag
                            i-tag-other_2">
            #etcd
        </a>
                        
                        <a href="https://lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-banana">
            #è®¡ç®—æœº
        </a>
                        
                        <a href="https://lwhile.github.io/tag/5UKnY2CH9d" class="post-tag i-tag
                            i-tag-other_3">
            #Go
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            å…¬å¸çš„ä¸šåŠ¡é‡Œé¢ä½¿ç”¨äº†ConsulåšæœåŠ¡å‘ç°, å‘ç°å…¶æœ‰ä¸€ä¸ªwatchæœºåˆ¶.è¿™ä¸ªwatchæœºåˆ¶å¼•èµ·æˆ‘çš„å¥½å¥‡, å› ä¸ºåˆšå¥½åœ¨çœ‹Etcd-raftçš„ä»£ç , Etcdä¹Ÿæœ‰ç±»ä¼¼çš„watchæœºåˆ¶, æ‰€ä»¥è¶çƒ­æ‰“é“, èµ¶ç´§è¶å‘¨æœ«ç ”ç©¶ä¸‹etcd watchæœºåˆ¶æºç çš„å®ç°.
åœ¨çœ‹æºç ä¹‹å‰, æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­, çœ‹çœ‹Etcdçš„watchæ˜¯å¦‚ä½•ä½¿ç”¨çš„.

å…ˆå¾€Etcdå†™å…¥ä¸€å¯¹KV


curl http://127.0.0.1:2379/v2/keys/name -XPUT -d value=&amp;quot;ç¥è›‹ä½¿è€…&amp;quot;


Watchè¿™å¯¹KV


curl http://127.0.0.1:2379/v2/keys/name?wait=true

å¦‚æœä¸€åˆ‡æ­£å¸¸, è¿™æ—¶å€™è¯·æ±‚ä¼šè¢«é˜»å¡ä½.

æ–°å¼€ä¸€ä¸ªç»ˆç«¯, ä¿®æ”¹å­˜è¿›å»çš„KV


curl http://127.0.0.1:2379/v2/keys/name -XPUT -d value=ç¥è›‹ä½¿è€…1å·


é˜»å¡çš„é‚£ä¸ªè¯·æ±‚è¿”å›watchåˆ°çš„ç»“æœ

{
  &amp;quot;action&amp;quot;:&amp;quot;set&amp;quot;,
  &amp;quot;node&amp;quot;:{ 
      &amp;quot;key&amp;quot;:&amp;quot;/name&amp;quot;,
      &amp;quot;value&amp;quot;:&amp;quot;ç¥è›‹ä½¿è€…1å·&amp;quot;,
      &amp;quot;modifiedIndex&amp;quot;:25,
     &amp;quot;createdIndex&amp;quot;:25
  },
   &amp;quot;prevNode&amp;quot;: {
     &amp;quot;key&amp;quot;:&amp;quot;/name&amp;quot;,
     &amp;quot;value&amp;quot;:&amp;quot;ç¥è›‹ä½¿è€…&amp;quot;,
     &amp;quot;modifiedIndex&amp;quot;:24,
     &amp;quot;createdIndex&amp;quot;:24
   }
  }

ä½“éªŒæµç¨‹å¤§æ¦‚å°±æ˜¯è¿™æ ·, ä¸‹é¢æ­£å¼çœ‹æºç .
æ¥å£å®šä¹‰
type Watcher interface {
	// Watch watches on a key or prefix. The watched events will be returned
	// through the returned channel.
	// If the watch is slow or the required rev is compacted, the watch request
	// might be canceled from the server-side and the chan will be closed.
	// &#39;opts&#39; can be: &#39;WithRev&#39; and/or &#39;WithPrefix&#39;.
	Watch(ctx context.Context, key string, opts ...OpOption) WatchChan

	// Close closes the watcher and cancels all watch requests.
	Close() error
}

è¯¥æ¥å£å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•, Watch å’Œ Close
Watch æ–¹æ³•è¿”å›ä¸€ä¸ªWatchChan ç±»ä¼¼çš„å˜é‡, WatchChanæ˜¯ä¸€ä¸ªchannel, å®šä¹‰å¦‚ä¸‹:
type WatchChan &amp;lt;-chan WatchResponse

è¯¥é€šé“ä¼ é€’WatchResponseç±»å‹
type WatchResponse struct {
	Header pb.ResponseHeader
	Events []*Event

	// CompactRevision is the minimum revision the watcher may receive.
	CompactRevision int64

	// Canceled is used to indicate watch failure.
	// If the watch failed and the stream was about to close, before the channel is closed,
	// the channel sends a final response that has Canceled set to true with a non-nil Err().
	Canceled bool

	// Created is used to indicate the creation of the watcher.
	Created bool

	closeErr error
}

å…¶ä¸­Eventç±»å‹æ˜¯ä¸€ä¸ªgRPCç”Ÿæˆçš„æ¶ˆæ¯å¯¹è±¡
type Event struct {
	// type is the kind of event. If type is a PUT, it indicates
	// new data has been stored to the key. If type is a DELETE,
	// it indicates the key was deleted.
	Type Event_EventType `protobuf:&amp;quot;varint,1,opt,name=type,proto3,enum=mvccpb.Event_EventType&amp;quot; json:&amp;quot;type,omitempty&amp;quot;`
	// kv holds the KeyValue for the event.
	// A PUT event contains current kv pair.
	// A PUT event with kv.Version=1 indicates the creation of a key.
	// A DELETE/EXPIRE event contains the deleted key with
	// its modification revision set to the revision of deletion.
	Kv *KeyValue `protobuf:&amp;quot;bytes,2,opt,name=kv&amp;quot; json:&amp;quot;kv,omitempty&amp;quot;`
	// prev_kv holds the key-value pair before the event happens.
	PrevKv *KeyValue `protobuf:&amp;quot;bytes,3,opt,name=prev_kv,json=prevKv&amp;quot; json:&amp;quot;prev_kv,omitempty&amp;quot;`
}

æ¥ä¸‹æ¥çœ‹å®ç°äº†Watcheræ¥å£çš„watcherç±»å‹
// watcher implements the Watcher interface
type watcher struct {
	remote pb.WatchClient

	// mu protects the grpc streams map
	mu sync.RWMutex

	// streams holds all the active grpc streams keyed by ctx value.
	streams map[string]*watchGrpcStream
}

watcherç»“æ„å¾ˆç®€å•, åªæœ‰3ä¸ªå­—æ®µ. remoteæŠ½è±¡äº†å‘èµ·watchè¯·æ±‚çš„å®¢æˆ·ç«¯, streamsæ˜¯ä¸€ä¸ªmap, è¿™ä¸ªmapæ˜ å°„äº†äº¤äº’çš„æ•°æ®æµ.è¿˜æœ‰ä¸€ä¸ªä¿æŠ¤å¹¶å‘ç¯å¢ƒä¸‹æ•°æ®æµè¯»å†™å®‰å…¨çš„è¯»å†™é”.
streamsæ‰€å±çš„watchGrpcStreamç±»å‹æŠ½è±¡äº†æ‰€æœ‰äº¤äº’çš„æ•°æ®, å®ƒçš„ç»“æ„å®šä¹‰å¦‚ä¸‹:
type watchGrpcStream struct {
	owner  *watcher
	remote pb.WatchClient

	// ctx controls internal remote.Watch requests
	ctx context.Context
	// ctxKey is the key used when looking up this stream&#39;s context
	ctxKey string
	cancel context.CancelFunc

	// substreams holds all active watchers on this grpc stream
	substreams map[int64]*watcherStream
	// resuming holds all resuming watchers on this grpc stream
	resuming []*watcherStream

	// reqc sends a watch request from Watch() to the main goroutine
	reqc chan *watchRequest
	// respc receives data from the watch client
	respc chan *pb.WatchResponse
	// donec closes to broadcast shutdown
	donec chan struct{}
	// errc transmits errors from grpc Recv to the watch stream reconn logic
	errc chan error
	// closingc gets the watcherStream of closing watchers
	closingc chan *watcherStream
	// wg is Done when all substream goroutines have exited
	wg sync.WaitGroup

	// resumec closes to signal that all substreams should begin resuming
	resumec chan struct{}
	// closeErr is the error that closed the watch stream
	closeErr error
}

æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯, watchGrpcStreamä¹ŸåŒ…å«äº†ä¸€ä¸ªwatcherç±»å‹çš„ownerå­—æ®µ, watcherå’ŒwatchGrpcStreamå¯ä»¥äº’ç›¸å¼•ç”¨åˆ°å¯¹æ–¹.åŒæ—¶åˆå®šä¹‰äº†watcherç±»å‹ä¸­å·²ç»å®šä¹‰è¿‡çš„remote,è€Œä¸”è¿˜ä¸æ˜¯æŒ‡é’ˆç±»å‹, è¿™ç‚¹ä¸å¤§æ˜ç™½ä½œç”¨æ˜¯å•¥.
è¿˜æœ‰å‡ ä¸ªå­—æ®µå€¼å¾—å…³æ³¨, ä¸€ä¸ªæ˜¯substreams, çœ‹ä¸‹å®ƒçš„å®šä¹‰å’Œæ³¨é‡Š:
// substreams holds all active watchers on this grpc stream
substreams map[int64]*watcherStream

å†çœ‹çœ‹watcherStreamç±»å‹çš„å®šä¹‰:
// watcherStream represents a registered watcher
type watcherStream struct {
	// initReq is the request that initiated this request
	initReq watchRequest

	// outc publishes watch responses to subscriber
	outc chan WatchResponse
	// recvc buffers watch responses before publishing
	recvc chan *WatchResponse
	// donec closes when the watcherStream goroutine stops.
	donec chan struct{}
	// closing is set to true when stream should be scheduled to shutdown.
	closing bool
	// id is the registered watch id on the grpc stream
	id int64

	// buf holds all events received from etcd but not yet consumed by the client
	buf []*WatchResponse
}

ç”»ä¸ªå›¾æ•´ç†ä¸‹ä»–ä»¬ä¹‹é—´çš„å…³ç³»:

æ¥ä¸‹æ¥è½®åˆ°watcheræ˜¯å¦‚ä½•watchæ–¹æ³•çš„äº†:
// Watch posts a watch request to run() and waits for a new watcher channel
func (w *watcher) Watch(ctx context.Context, key string, opts ...OpOption) WatchChan {
	// åº”ç”¨é…ç½®
	ow := opWatch(key, opts...)

	var filters []pb.WatchCreateRequest_FilterType
	if ow.filterPut {
		filters = append(filters, pb.WatchCreateRequest_NOPUT)
	}
	if ow.filterDelete {
		filters = append(filters, pb.WatchCreateRequest_NODELETE)
	}

	// æ ¹æ®ä¼ å…¥çš„å‚æ•°æ„é€ watchè¯·æ±‚
	wr := &amp;amp;watchRequest{
		ctx:            ctx,
		createdNotify:  ow.createdNotify,
		key:            string(ow.key),
		end:            string(ow.end),
		rev:            ow.rev,
		progressNotify: ow.progressNotify,
		filters:        filters,
		prevKV:         ow.prevKV,
		retc:           make(chan chan WatchResponse, 1),
	}

	ok := false
	// å°†è¯·æ±‚ä¸Šä¸‹æ–‡æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
	ctxKey := fmt.Sprintf(&amp;quot;%v&amp;quot;, ctx)

	// find or allocate appropriate grpc watch stream
	// æ¥ä¸‹æ¥é…ç½®å¯¹åº”çš„è¾“å‡ºæµ, æ³¨æ„å¾—åŠ é”
	w.mu.Lock()

	// å¦‚æœstreamä¸ºç©º, è¿”å›ä¸€ä¸ªå·²ç»å…³é—­çš„channel.
	// è¿™ç§æƒ…å†µåº”è¯¥æ˜¯é˜²æ­¢streamsä¸ºç©ºçš„æƒ…å†µ
	if w.streams == nil {
		// closed
		w.mu.Unlock()
		ch := make(chan WatchResponse)
		close(ch)
		return ch
	}

	// æ³¨æ„è¿™é‡Œ, å‰é¢æˆ‘ä»¬æåˆ°streamsæ˜¯ä¸€ä¸ªmap,è¯¥mapçš„keyæ˜¯è¯·æ±‚ä¸Šä¸‹æ–‡
	// å¦‚æœè¯¥è¯·æ±‚å¯¹åº”çš„æµä¸ºç©º,åˆ™æ–°å»º
	wgs := w.streams[ctxKey]
	if wgs == nil {
		wgs = w.newWatcherGrpcStream(ctx)
		w.streams[ctxKey] = wgs
	}
	donec := wgs.donec
	reqc := wgs.reqc
	w.mu.Unlock()

	// couldn&#39;t create channel; return closed channel
        // couldn&#39;t create channel; return closed channel
	// è¿™é‡Œè¦è®¾ç½®ä¸ºç¼“å†²çš„åŸå› å¯èƒ½ä¸ä¸‹é¢çš„ä¸¤ä¸ª
	// closeCh &amp;lt;- WatchResponse{closeErr: wgs.closeErr}
	// è¯­å¥æœ‰å…³,è¿™é‡Œä¸ç†è§£
	closeCh := make(chan WatchResponse, 1)

	// submit request
	select {
	// å‘é€ä¸Šé¢æ„é€ å¥½çš„watchè¯·æ±‚ç»™å¯¹åº”çš„æµ
	case reqc &amp;lt;- wr:
		ok = true
	// è¯·æ±‚æ–­å¼€(è¿™é‡Œåº”è¯¥å›Šæ‹¬äº†å®¢æˆ·ç«¯è¯·æ±‚æ–­å¼€çš„æ‰€æœ‰æƒ…å†µ)
	case &amp;lt;-wr.ctx.Done():
	// watchå®Œæˆ
	// è¿™é‡Œåº”è¯¥æ˜¯å¤„ç†éæ­£å¸¸å®Œæˆçš„æƒ…å†µ
	// æ³¨æ„ä¸‹é¢çš„é‡è¯•é€»è¾‘
	case &amp;lt;-donec:
		if wgs.closeErr != nil {
			// å¦‚æœä¸æ˜¯ç©ºä¸Šä¸‹æ–‡å¯¼è‡´æµè¢«ä¸¢å¼ƒçš„æƒ…å†µ
			// åˆ™ä¸åº”è¯¥é‡è¯•
			closeCh &amp;lt;- WatchResponse{closeErr: wgs.closeErr}
			break
		}
		// retry; may have dropped stream from no ctxs
		return w.Watch(ctx, key, opts...)
	}

	// receive channel
	// å¦‚æœæ˜¯åˆå§‹è¯·æ±‚é¡ºåˆ©å‘é€æ‰ä¼šæ‰§è¡Œè¿™é‡Œ
	if ok {
		select {
		case ret := &amp;lt;-wr.retc:
			return ret
		case &amp;lt;-ctx.Done():
		case &amp;lt;-donec:
			if wgs.closeErr != nil {
				closeCh &amp;lt;- WatchResponse{closeErr: wgs.closeErr}
				break
			}
			// retry; may have dropped stream from no ctxs
			return w.Watch(ctx, key, opts...)
		}
	}

	close(closeCh)
	return closeCh
}

è¿˜æœ‰Watcheræ¥å£çš„å¦ä¸€ä¸ªæ–¹æ³•Close:
func (w *watcher) Close() (err error) {
	// åœ¨é”å†…å…ˆå°†streamså­—æ®µç½®ä¸ºç©º
	// åœ¨é”å¤–å†å°†ä¸€ä¸ªä¸ªæµéƒ½å…³é—­
	// è¿™æ ·åšçš„æ„ä¹‰åœ¨äºä¸ç®¡å“ªä¸ªæµå…³é—­å¤±è´¥äº†
	// éƒ½èƒ½å…ˆä¿è¯streamsä¸è¿™äº›æµçš„å…³ç³»è¢«åˆ‡æ–­
	w.mu.Lock()
	streams := w.streams
	w.streams = nil
	w.mu.Unlock()
	for _, wgs := range streams {
		if werr := wgs.Close(); werr != nil {
			err = werr
		}
	}
	// etcdç«Ÿç„¶ä¹Ÿåªæ˜¯è¿”å›ä¸€ä¸ªerror
	// è™½ç„¶ä¸Šé¢çš„forå¾ªç¯å¯èƒ½äº§ç”Ÿå¤šä¸ªerror
	return err
}

è¿™æ ·watcherå°±å®ç°äº†Watcheræ¥å£.å¤§è‡´çš„å®ç°æ€è·¯æœ¬æ–‡å°±ä»‹ç»åˆ°è¿™é‡Œ,å‰©ä¸‹çš„ä»£ç ä¹Ÿéƒ½æ˜¯å¯¹å…¶ä»–ç›¸å…³æ•°æ®ç»“æ„çš„é€»è¾‘åŒ…è£…æ“ä½œ.
ç®€å•é˜…è¯»Etcdçš„è¿™ä¸€å°éƒ¨åˆ†æºç ä¸‹æ¥, æˆ‘çœ‹åˆ°ä»–ä»¬æºç ä¸­çš„ä¸¤ä¸ªä¸œè¥¿,ç®—æ˜¯Golangæˆ–è€…ç¼–ç¨‹ä¸Šé¢çš„ä¸€äº›æœ€ä½³å®è·µ:


å¯¹åŒ…å¤–åªæš´éœ²ä¸€ä¸ªå…¬å…±æ¥å£, åŒ…å†…çš„ç»“æ„ä½“å®ç°è¯¥æ¥å£å³å¯.å°±åƒæœ¬æ–‡ä¸­çš„Watcheræ¥å£å’Œwatcherç»“æ„ä½“.è¿™æ ·æœ‰ä¸¤ä¸ªå¥½å¤„, ä¸€ä¸ªå°±æ˜¯ä»£ç èƒ½å¤Ÿè§£è€¦,è¿˜æœ‰å°±æ˜¯å¯ä»¥çœå»å‘½åçš„è‹¦æ¼(__)


å¦ä¸€ä¸ªæ˜¯æ³¨é‡Šçš„ä¹¦å†™æ–¹å¼,æˆ‘å‘ç°etcdæºç é‡Œçš„æ³¨é‡Šå¾ˆå¤§ä¸€éƒ¨åˆ†å†™åœ¨å˜é‡çš„å®šä¹‰ä¸Šé¢,è€Œä¸”å˜é‡çš„å®šä¹‰åéƒ½å¾ˆæ¸…æ™°.


æŠ½è±¡å¾—ä½“.è¿™ä¸ªå…¶å®ä¸åªæ˜¯Etcd, å…¶ä»–ä»»ä½•ä¼˜ç§€çš„å¼€æºä½œå“éƒ½æŠŠä»–ä»¬çš„ä»£ç æŠ½è±¡å¾—å¾ˆåˆ°ä½.çªç„¶æƒ³èµ·æˆ‘å†™çš„é‚£äº›æ¸£æ¸£ä»£ç %&amp;gt;_&amp;lt;%


æœ€å, æ€»ç»“ä¸‹etcdçš„watchæœºåˆ¶.å…¶å®å½’æ ¹ç»“åº•, å®ƒçš„watchæ˜¯é€šè¿‡gRPCçš„å¤šè·¯å¤ç”¨å®ç°çš„,è¿™æ˜¯ä¸€ä¸ªåŸºäºHTTP/2çš„ç‰¹æ€§.æ‰€ä»¥æœ¬æ–‡å¯èƒ½æœ‰äº›åç¦»äº†ä¸»é¢˜,æ¢è®¨Etcdçš„watchæœºåˆ¶, å…¶å®åº”è¯¥ç ”ç©¶HTTP/2æ‰æ˜¯.
ç®—æ˜¯ç»™è‡ªå·±æŒ–ä¸ªå‘.

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://lwhile.github.io/post/etcd-watch-source-code">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://lwhile.github.io/post/hi-openresty">
                        ä½¿ç”¨Openrestyæ„å»ºè®¤è¯ç½‘å…³
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2017-11-07</time>
                    
                        <a href="https://lwhile.github.io/tag/s2UnbI257" class="post-tag i-tag
                            i-tag-primary">
            #openresty
        </a>
                        
                        <a href="https://lwhile.github.io/tag/94Hr92W69j" class="post-tag i-tag
                            i-tag-other_3">
            #ç½‘ç»œ
        </a>
                        
                        <a href="https://lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-success">
            #è®¡ç®—æœº
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            åœ¨å•ä½“åº”ç”¨ä¸­, æˆ‘ä»¬å¯ä»¥é€šè¿‡ cookie + session, æˆ–è€… JSON web token, å°†è®¤è¯é€»è¾‘åœ¨å•ä½“åº”ç”¨ä¸­å®ç°, ç®€å•é«˜æ•ˆ, è¿˜ç‰¹åˆ«çœäº‹.
ç„¶è€Œè¿™å‡ å¹´éšç€æœåŠ¡åŒ–æ½®æµè¶Šæ¥è¶Šç«(æˆ‘è§‰å¾—è¿™æ˜¯å¿…ç„¶è¶‹åŠ¿, æƒ³æƒ³æˆ‘ä»¬äººç±»ç¤¾ä¼šæ˜¯å¦‚ä½•è¿ä½œçš„), å¾ˆå¤šä»¥å‰å•ä½“åº”ç”¨ä¸å­˜åœ¨çš„é—®é¢˜, ç°åœ¨å·²æˆä¸ºå¯¹å•ä½“åº”ç”¨æ‹†åˆ†è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªéšœç¢, æ¯”å¦‚ç³»ç»Ÿçš„è®¤è¯ä½“ç³».
å¦‚æœæ¯ä¸ªæ‹†å‡ºæ¥çš„æœåŠ¡éƒ½è¦åšä¸€æ¬¡è®¤è¯(å°±æ˜¯ç¨‹åºå‘˜å¤šå†™å‡ ä»½è®¤è¯çš„ä»£ç å•¦), å¯¹äºæœ‰ç†æƒ³æœ‰è¿½æ±‚çš„çµé­‚ã®ç å†œæ¥è¯´, æ˜¯ç»å¯¹æ— æ³•æ¥å—çš„.ä½ è¯´è®¤è¯ä»£ç copyå°±å¥½äº†, ä¸ç”¨é‡æ–°å†™.no no no, è¿™æ ·æå‡ºæ¥çš„æ¶æ„ä¸ä»…çœ‹ç€åˆ«æ‰­, ä»£ç é—»ç€å°±è§‰å¾—è‡­, è€Œä¸”è¿Ÿæ—©æœ‰ä¸€å¤©ä¼šå‡ºé—®é¢˜.
è§£å†³å•ä½“åº”ç”¨æ‹†åˆ†æœåŠ¡åçš„è®¤è¯é—®é¢˜å…¶å®å¾ˆå¸¸è§„, å›æƒ³ä¸‹ç¥–å¸ˆçˆ·ä»¬å¸®æˆ‘ä»¬æ€»ç»“çš„ä¸€å¥è¯: &amp;quot;Any problem in computer science can be solved by another layer of indirection.&amp;quot; æˆ‘ä»¬å¯ä»¥åœ¨æ‰€æœ‰æœåŠ¡å‰é¢å¢åŠ ä¸€å±‚è®¤è¯æœåŠ¡.

çœ‹åˆ°è®¤è¯æœåŠ¡è¿™ä¸€å±‚ç”¨æ¥ä½œä¸ºç”¨æˆ·è¯·æ±‚çš„æ€»å…¥å£, æœ‰Nginxæˆ–è€…Apacheä½¿ç”¨ç»éªŒçš„åŒå­¦è‡ªç„¶è€Œç„¶å°±æƒ³åˆ°å®ƒä»¬. å¦‚æœèƒ½æŠŠè®¤è¯æ¨¡å—çš„åŠŸèƒ½æ•´åˆè¿›Nginxæˆ–è€…Apacheè¿™äº›WebæœåŠ¡å™¨, é‚£å²‚ä¸æ˜¯æ›´å®Œç¾ ?
è€Œè¿™ç¯‡æ–‡ç« çš„ä¸»è§’: Openresty,å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®€å•å¿«é€Ÿå¾—å®Œæˆè¿™ä¸ªæƒ³æ³•.è¿™æ˜¯ä¸€ä¸ªç”±æ˜¥å“¥(Github)å‘èµ·çš„é¡¹ç›®.ä½ å¯ä»¥å°†Openrestyçœ‹åšNginx + å¸¸ç”¨æ¨¡å—æ„æˆçš„è½¯ä»¶åŒ…, ä½†æ˜¯æœ€é‡è¦çš„åŠŸèƒ½æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Luaåœ¨Nginxå®ç°Webæ¡†æ¶æ‰èƒ½å®ç°çš„é€»è¾‘, æ¥ä¸‹æ¥æ–‡ç« å°†ä¼šå¼€å§‹ä»‹ç»å¦‚ä½•ä½¿ç”¨Openresty, å°†ä¸Šé¢æåˆ°çš„è®¤è¯æœåŠ¡æ•´åˆè¿›Nginxé‡Œ.
å®‰è£…
Openrestyæœ‰ä¸¤ç§å®‰è£…æ–¹å¼, ä¸€ç§æ˜¯ä½¿ç”¨æºç ç¼–è¯‘å®‰è£….ä¸€ç§ä½¿ç”¨å®˜æ–¹æä¾›çš„é¢„ç¼–è¯‘åŒ…:
å…·ä½“å¯å‚è€ƒå®˜ç½‘çš„å®‰è£…æ–‡æ¡£
Hello world
å¦‚æœä½ æ²¡ä¿®æ”¹è¿‡Openrestyçš„å®‰è£…ä½ç½®, é»˜è®¤ä¼šè¢«å®‰è£…åœ¨/use/local/openrestyç›®å½•ä¸‹.æˆ‘ä»¬ç°åœ¨å¯ä»¥å°è¯•å†™ä¸€ä¸ªHello worldçº§åˆ«çš„demo.
ä¸ºOpenrestyåˆ›å»ºå·¥ä½œç›®å½•å¹¶åˆ›å»ºé…ç½®æ–‡ä»¶:

mkdir ~/openresty_work
cd ~/openresty_work
touch nginx.conf

æ¥ä¸‹æ¥åœ¨nginx.confé‡Œé¢é…ç½®ä¸€ä¸ªè·¯ç”±è§„åˆ™
worker_processes 1;
error_log logs/error.log;

events {
	worker_connections 1024;
}

http {
	server {
		listen 8080;
		location /hello {
			default_type text/html;
			content_by_lua_block {
				ngx.say(&amp;quot;Hello Openresty.&amp;quot;)
			}			
		}
	}
}


è·Ÿæ™®é€šçš„Nginxé…ç½®æ–‡ä»¶æ¯”èµ·æ¥, ä¸Šé¢çš„é…ç½®å¤šäº†ä¸€ä¸ªcontent_by_lua_blockæŒ‡ä»¤, æ­£æ˜¯é€šè¿‡è°ƒç”¨è¯¥æŒ‡ä»¤, è®¿é—®è¯¥è·¯ç”±çš„æ—¶å€™,æ‰ä¼šè¾“å‡ºç›¸åº”çš„å†…å®¹.è¿™ä¸ªæŒ‡ä»¤æ˜¯ç”±Openrestyä¸­çš„LuaNginxModuleæ¨¡å—æä¾›çš„åŠŸèƒ½, è¯·æ±‚è¿›æ¥çš„æ—¶å€™, Nginxä¼šå¯åŠ¨luaçš„è™šæ‹Ÿæœº, è¾“å‡ºçš„å†…å®¹åˆ™ç”±luaæä¾›.
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨content_by_lua_fileæŒ‡ä»¤æ›¿ä»£content_by_lua_block, å°†ç›¸å…³çš„luaä»£ç å†™è¿›æ–‡ä»¶é‡Œ.
location /hello {
			content_by_lua_file lua/hello.lua;
		}


--- hello.lua
ngx.say(&amp;quot;Hello Openresty.&amp;quot;)

æœ‰äº†ä¸Šé¢çš„é“ºå«,æ¥ä¸‹æ¥å¯ä»¥å¼€å§‹æ„å»ºæˆ‘ä»¬çš„è®¤è¯æœåŠ¡,è®¤è¯çš„æ–¹å¼ä½¿ç”¨JWT
Openrestyå°†ä¸€ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä¸º4ä¸ªé˜¶æ®µ:

æˆ‘ä»¬çš„è®¤è¯æœåŠ¡å°†ä¼šæŒ‚è½½åœ¨ç¬¬äºŒé˜¶æ®µ, å³ Rewrite/Access Phase ä¸Š.
æ¥ä¸‹æ¥å‡†å¤‡ä¸€ä¸ªéœ€è¦ç”¨åˆ°çš„åº“:
lua-resty-jwt
cloneä¸‹æ¥åæ”¾åˆ°hello.luaæ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹,å¹¶å°†lua_package_pathé…ç½®ä¸º:
lua_package_path &amp;quot;/root/openresty_work/lua/?.lua;/root/openresty_work/lua/lua-resty-jwt/lib/?.lua;;&amp;quot;;

æ„å»ºçš„æ€è·¯ä¹Ÿå¾ˆç®€å•, å¯¹ç”¨æˆ·æä¾›ä¸€ä¸ªç™»å½•è¯·æ±‚, éªŒè¯èº«ä»½åå°†jwt tokenåˆ†å‘ç»™ç”¨æˆ·.ç”¨æˆ·æ¥ä¸‹æ¥è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£, åˆ™åœ¨headeré‡Œé¢åŠ å…¥è¯¥token, è¯·æ±‚è¿›å…¥Openrestyåç”±luaæå–å‡ºtokenè¿›è¡Œè®¤è¯.
Nginxé…ç½®æ–‡ä»¶
server {
                listen 8080;
                location /hello {
                        content_by_lua_file lua/hello.lua;
                }
                location /login {
                        content_by_lua_file lua/sign.lua;
                }
                location /service1 {
                        access_by_lua_file lua/verify.lua;
                        # éœ€è¦åå‘ä»£ç†åœ¨è¿™é…ç½®
                }
                location /service {
                        access_by_lua_file lua/verify.lua;
                        # ...
                }
        }


ä¸‹é¢æ˜¯é…ç½®ä¸­ç›¸å…³çš„luaæ–‡ä»¶
sign.lua â†“:
local jwt = require &#39;resty.jwt&#39;

-- åªå…è®¸POSTè¯·æ±‚
if ngx.req.get_method() ~= &#39;POST&#39; then
    ngx.status = 405
    ngx.say(&amp;quot;Mehtod Not Allow&amp;quot;)
    return
end

-- è·å–è¯·æ±‚body
ngx.req.read_body()
local body_raw = ngx.req.get_body_data()
local body_json = cjson.decode(body_raw)
local username = body_json[&#39;username&#39;]
local password = body_json[&#39;password&#39;]

if not username or not password then
    ngx.log(ngx.ERR, username, password)
    ngx.status = 400
    ngx.say(&#39;æ— æ³•è·å–è´¦å·æˆ–è€…å¯†ç &#39;)
    return
end

-- éªŒè¯è´¦å·å’Œå¯†ç æ˜¯å¦æ­£ç¡®,å¦‚æœéªŒè¯å¤±è´¥åˆ™åšå¦‚ä¸‹å¤„ç†
if not this_is_a_auth_method(username, password) then
    ngx.status = 401
    ngx.say(&#39;è®¤è¯å¤±è´¥&#39;)
    return
end

verify.lua â†“:
local jwt = require &#39;resty.jwt&#39;

-- ä»è¯·æ±‚ä¸­æå–headerå¹¶ä»headerä»è·å–tokenå­—æ®µ
local headers = ngx.req.get_headers()
local token = headers[&#39;token&#39;]

-- æ£€æŸ¥tokenæ˜¯å¦å­˜åœ¨
if not token then 
    ngx.status = 400
    ngx.say(&#39;æ— æ³•è·å–token&#39;)
    return 
end 

-- éªŒè¯token
local jwt_obj = jwt:verify(vars.jwt_salt(), token)
if not jwt_obj[&#39;verified&#39;] then 
    ngx.status = 401
    ngx.say(&#39;æ— æ•ˆçš„token&#39;)
    return 
end 

è‡³æ­¤ä¸€ä¸ªä½¿ç”¨Openrestyæ„å»ºçš„è®¤è¯ç½‘å…³çš„é›å½¢å·²ç»å‡ºæ¥äº†.éœ€è¦è¯´æ˜çš„ä¸€å¥æ˜¯, ä¸Šé¢çš„ä»£ç ç”±äºæ²¡æœ‰å…¬å¸ç›¸å…³çš„è¿è¡Œç¯å¢ƒ,ç¬”è€…æ²¡æœ‰ç»è¿‡æµ‹è¯•å’ŒéªŒè¯.æ‰€ä»¥åªå¯é˜…è¯»,ä¸å¯å¤åˆ¶åç›´æ¥è¿è¡Œ ğŸ˜ƒ
å¦‚æœæƒ³æŠŠè¿™å¥—è®¤è¯ç½‘å…³ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸Š, è¿˜æœ‰å¾ˆå¤šä¸œè¥¿éœ€è¦è€ƒè™‘.æ¯”å¦‚è·¨åŸŸé—®é¢˜, é™æ€æ–‡ä»¶çš„ä»£ç†é—®é¢˜ç­‰ç­‰.
ä¸ªäººæ¥è§¦Openrestyçš„æ—¶é—´ä¹Ÿä¸é•¿, æ–‡ä¸­éš¾å…ä¼šæœ‰åœ°æ–¹å†™é”™äº†æˆ–è€…è¡¨è¾¾å¾—å¾ˆå·®, æ¬¢è¿å‘è¯„è®ºæˆ–è€…å‘é‚®ä»¶ç»™æˆ‘æŒ‡æ­£: lwhile521@gmail.com ,æ„Ÿè°¢.
å¯¹äºOpenresty, ä¸ªäººè®¤ä¸ºè¦å¯¹å®ƒäº§ç”Ÿå…´è¶£,å…³é”®åœ¨äºè®¤ä¸è®¤å¯è®©Nginxæ‰¿æ‹…é™¤äº†WebæœåŠ¡å™¨ä¹‹å¤–æ›´å¤šçš„ä¸šåŠ¡, å¯¹äºOpenresty, å®ƒèƒ½å¸¦æ¥çš„å¥½å¤„æœ‰:


æè‡´çš„æ€§èƒ½.ä¸Šæ–‡æ²¡æœ‰æåˆ°Openrestyçš„æ€§èƒ½, å…¶å®Openrestyçš„ç¼–ç¨‹æ¨¡å‹å’ŒNodeJSå¾ˆåƒ, åœ¨Openrestyçš„ä¸–ç•Œé‡Œé¢,æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯éé˜»å¡çš„,æ›´éš¾å¾—å¯è´µçš„æ˜¯, å®ƒä¸éœ€è¦ä½¿ç”¨NodeJSä¸­çš„å›è°ƒå‡½æ•°, ä»£ç å†™èµ·æ¥å…¶å®è¿˜æ˜¯åŒæ­¥æ¨¡å‹, é…åˆCè¯­è¨€ç¼–å†™çš„Nginx, æœ€å¿«çš„è„šæœ¬è¯­è¨€lua+luajitè§£é‡Šå™¨,è¿™å¥—æ–¹æ¡ˆçš„æ€§èƒ½æ— å¯æŒ‘å‰”äº†.


é™ä½äº†Nginxæ¨¡å—çš„å¼€å‘éš¾åº¦. Nginx + C/C++èƒ½åšçš„, Openrestyç”¨luaéƒ½èƒ½åš.å¼€å‘æ•ˆç‡é«˜äº†, æ€§èƒ½è¿˜ä¸æ€ä¹ˆé™, ä½•ä¹è€Œä¸ä¸ºå‘¢?


å‚è€ƒèµ„æ–™


Openrestyæœ€ä½³å®è·µ
lua-resty-jwt



                                        </div>
                                        
                                            <a class="btn btn-text" href="https://lwhile.github.io/post/hi-openresty">Read More ~</a>
                            </div>
                </div>
            </article>
            
            <article class="post i-card">
                <h2 class="post-title">
                    <a href="https://lwhile.github.io/post/ri-zhi-qie-fen-wen-ti-you-gan">
                        æ—¥å¿—åˆ‡åˆ†é—®é¢˜æœ‰æ„Ÿ
                    </a>
                </h2>
                <div class="post-info">
                    <time class="post-time">2017-11-05</time>
                    
                        <a href="https://lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-primary">
            #è®¡ç®—æœº
        </a>
                        
                </div>
                <div class="post-article">
                    
                            <div class="post-content">
                                
                                        <div class="post-content-content">
                                            æœ‰è¿‡æœåŠ¡ç«¯å¼€å‘ç»éªŒçš„åŒå­¦åº”è¯¥å¯¹æ—¥å¿—è¿™ä¸ªä¸œè¥¿ä¸é™Œç”Ÿ, æŠŠç¨‹åºä¸¢åˆ°æœåŠ¡å™¨ä¸Šè·‘, æ—¥å¿—å°±æ˜¯æˆ‘ä»¬äº†è§£è¿è¡Œæƒ…å†µ,ç”šè‡³è§£BUGçš„å”¯ä¸€å…¥å£äº†.
æœ‰äº›ç¨‹åºçš„æ—¥å¿—é‡ä¼šå¢é•¿å¾—éå¸¸å¿«, æ¯”å¦‚Nginx, å½“ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶å¤§åˆ°å‡ ç™¾MBç”šè‡³ä¸ŠGBçš„æ—¶å€™, è¦ä»è¿™ä¸ªæ–‡ä»¶æ‰¾å‡ºæˆ‘ä»¬è¦çš„ä¿¡æ¯å°±åŸºæœ¬ç­‰äºå¤§æµ·æé’ˆäº†,æ‰€ä»¥è¿™æ—¶å€™å¯¹æ—¥å¿—è¿›è¡Œç®¡ç†å°±æ˜¾å¾—æ ¼å¤–é‡è¦.
æ—¥å¿—é‡å¤§çš„å¹³å°å¯ä»¥ä¸ŠELK,åˆ©ç”¨ESçš„æœç´¢ä¼˜åŠ¿åŸºæœ¬ä¸æ‹…å¿ƒæ—¥å¿—æ•°æ®é‡å¤§çš„é—®é¢˜.ä½†æœ¬æ–‡ä¸æ‰“ç®—æ¶‰åŠè¿™æ–¹é¢çš„å†…å®¹.æ¥ä¸‹æ¥ä¸»è¦è®²è®²å¦‚ä½•æ­£ç¡®å¾—å¯¹æ—¥å¿—æ–‡ä»¶åšåˆ‡åˆ†.
Linxuä¸Šçš„æ—¥å¿—åˆ‡åˆ†æœ‰ä¸¤ç§å½¢å¼, ä¸€ç§æ˜¯ä½¿ç”¨Linuxçš„logrotateå·¥å…·, å¦å¤–ä¸€ç§æ˜¯ä½¿ç”¨é¢å¤–ç¼–å†™çš„è„šæœ¬, è¿™ç§å½¢å¼ä¸€èˆ¬æ˜¯å’Œæ—¥å¿—åº“é…åˆä½¿ç”¨.
å› ä¸ºä¸šåŠ¡çš„å…³ç³», æˆ‘ä»¬æœ€å¼€å§‹æŠ›å¼ƒäº†ä½¿ç”¨logrotateçš„æ–¹æ¡ˆ, å› ä¸ºæˆ‘ä»¬è§‰å¾—è¿™ä¼šç»™å®æ–½äººå‘˜å¢åŠ ç³»ç»Ÿçš„çš„ç»´æŠ¤è´Ÿæ‹…(åæ¥å‘ç°æ˜¯æˆ‘ä»¬å¯¹logrotateä¸å¤Ÿäº†è§£).äºæ˜¯æˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆ, å°†æ—¥å¿—çš„åˆ‡åˆ†æ“ä½œåœ¨æˆ‘ä»¬çš„æ—¥å¿—åº“é‡Œé¢å®ç°, æˆ‘ä»¬å°è£…äº†logruså’Œlfshook, åˆ©ç”¨logrusçš„hookæœºåˆ¶å°†åˆ‡åˆ†çš„é€»è¾‘åµŒå…¥åœ¨æ—¥å¿—åº“é‡Œé¢,ä»£ç è°ƒç”¨çš„æ—¶å€™ä¼šè‡ªåŠ¨è§¦å‘åˆ‡åˆ†æ“ä½œ.æˆ‘ä»¬ä¼šè¿™æ ·åšä¹Ÿæ˜¯å—åˆ°beegoæ¡†æ¶çš„å½±å“, å®ƒçš„æ—¥å¿—åº“é»˜è®¤å°±å¸¦äº†åˆ‡åˆ†åŠŸèƒ½.
ä¸€åˆ‡è¿ä½œå¾—å¾ˆé¡ºåˆ©, ç›´åˆ°æˆ‘ä»¬æœ‰ä¸€æ¬¡åœ¨ä½¿ç”¨Openrestyçš„æ—¶å€™, å‘ç°Nginxçš„æ—¥å¿—æ²¡æœ‰è¢«åˆ‡åˆ†.å› ä¸ºä¹‹å‰ä½¿ç”¨Nginxçš„æ—¶å€™,é»˜è®¤å®‰è£…å®Œæ¯•åæ—¥å¿—æ˜¯ä¼šè‡ªåŠ¨ä»¥å¤©åˆ‡åˆ†çš„, äºæ˜¯æˆ‘ä»¬å¼€å§‹æ‰¾Nginxçš„é…ç½®é¡¹,çœ‹çœ‹æ˜¯å¦æ¼æ‰äº†æŸäº›é…ç½®.ä½†æ˜¯ä¸æ‰¾æ²¡å…³ç³»,äº†è§£åæ‰å‘ç°Nginxæ˜¯ä¸æä¾›æ—¥å¿—åˆ‡åˆ†åŠŸèƒ½çš„.What ? é‚£ä¹‹å‰çš„åˆ‡åˆ†åŠŸèƒ½æ˜¯æ€ä¹ˆæ¥çš„?
æ¥ä¸‹æ¥è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­å‘ç°äº†åœ¨/etc/logrotate.d/ä¸‹æœ‰nginxçš„é…ç½®, åŒæ—¶è¿˜æœ‰Mysqlå’Œå…¶ä»–åŸºç¡€ç»„ä»¶çš„,è¿™æ—¶æˆ‘ä»¬æ‰æƒ³åˆ°æœ‰å¯èƒ½æ˜¯RPMåŒ…(æˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯Centos)å®‰è£…çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆäº†ä¸€ä¸ªlogrotateçš„é…ç½®æ–‡ä»¶,åæ¥ä¸€æŸ¥æœç„¶æ˜¯(å‘½ä»¤:rpm -qpl xxx.rpm).è€Œæˆ‘ä»¬çš„OpenrestyåŒ…æ²¡æœ‰ç”Ÿæˆè¿™ä¸ªé…ç½®æ–‡ä»¶,æ‰€ä»¥å¯¼è‡´Nginxçš„æ—¥å¿—æ–‡ä»¶æ²¡æœ‰è¢«åˆ‡åˆ†.
å®é™…ä¸Šå¾ˆå¤šè½¯ä»¶éƒ½åªä¼šåšæ—¥å¿—çš„è®°å½•,ä¸ä¼šå¸®å¿™åšåˆ‡åˆ†,è¿™ä¸ªç¡®å®æ˜¯åˆç†çš„.è¿™è®©æˆ‘ä»¬æƒ³èµ·logrusä¸ºä»€ä¹ˆä¸æä¾›æ—¥å¿—åˆ‡åˆ†çš„åŠŸèƒ½,è€Œæ˜¯å¾—ç”±ç¬¬ä¸‰æ–¹çš„åº“å»å®Œæˆ.æˆ‘ä»¬å°†æ—¥å¿—åˆ‡åˆ†çš„é€»è¾‘è€¦åˆè¿›ä»£ç é‡Œé¢,ç°åœ¨å›è¿‡å¤´æ¥çœ‹å…¶å®ä¹Ÿä¸æ˜¯å¾ˆåˆç†,æ­£ç¡®çš„åšæ³•å…¶å®è¿˜æ˜¯åº”è¯¥åœ¨æ‰“RPMåŒ…çš„æ—¶å€™, ç”Ÿæˆä¸€ä¸ªlogrotateçš„é…ç½®æ–‡ä»¶, è¿™æ ·ä¸€æ¥ä¹Ÿä¸ä¼šå¢åŠ å®æ–½äººå‘˜çš„è´Ÿæ‹…,è€Œä¸”ä¹Ÿå¯ä»¥å°†åˆ‡åˆ†åŠŸèƒ½ç»Ÿä¸€åˆ°ä¸€ä¸ªåœ°æ–¹å»åš.

                                        </div>
                                        
                                            <a class="btn btn-text" href="https://lwhile.github.io/post/ri-zhi-qie-fen-wen-ti-you-gan">Read More ~</a>
                            </div>
                </div>
            </article>
            
                <!-- ç¿»é¡µ -->
                
                </div>
                <!--  -->
                <div class="main-container-middle"></div>
                <!--  -->
                <div id="sidebar" class="main-container-right">

                    <!-- ä¸ªäººä¿¡æ¯ -->
                    
    <div class="id_card i-card">
        <div class="id_card-avatar" style="background-image: url(https://lwhile.github.io/images/avatar.png?v=1576339500229)">
        </div>
        <h1 class="id_card-title">
            ç¥è›‹æ‚è°ˆ
        </h1>
        <h2 class="id_card-description">
            
        </h2>
        <!--  -->
        <div class="id_card-sns">
            <!-- github -->
            
                    <!-- twitter -->
                    
                            <!-- weibo -->
                            
                                    <!-- facebook -->
                                    

        </div>
    </div>
    

                        <!-- å…¬å‘Šæ  -->
                        

                </div>
            </div>



            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://lwhile.github.io/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
</body>

</html>