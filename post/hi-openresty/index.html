<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
    ä½¿ç”¨Openrestyæ„å»ºè®¤è¯ç½‘å…³ | ç¥è›‹æ‚è°ˆ
</title>
<link rel="shortcut icon" href="lwhile.github.io/favicon.ico?v=1576339253287">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="lwhile.github.io/styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="lwhile.github.io/media/js/jquery.sticky-sidebar.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


        
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="lwhile.github.io">
                <img class="avatar" src="lwhile.github.io/images/avatar.png?v=1576339253287" alt="">
            </a>
            <div class="site-title">
                <h1>
                    ç¥è›‹æ‚è°ˆ
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    é¦–é¡µ
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    å½’æ¡£
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    æ ‡ç­¾
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    å…³äº
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

            <div id="main-content" class="post-detail main-container">
                <!-- left -->
                <div id="content" class="main-container-left">
                    <article class="post i-card">
                        <h2 class="post-title">
                            ä½¿ç”¨Openrestyæ„å»ºè®¤è¯ç½‘å…³
                        </h2>
                        <div class="post-info">
                            <time class="post-time">2017-11-07</time>
                            
                                <a href="lwhile.github.io/tag/s2UnbI257" class="post-tag i-tag
                            i-tag-success">
                            #openresty
                        </a>
                                
                                <a href="lwhile.github.io/tag/94Hr92W69j" class="post-tag i-tag
                            i-tag-warning">
                            #ç½‘ç»œ
                        </a>
                                
                                <a href="lwhile.github.io/tag/GQVNWsaTp" class="post-tag i-tag
                            i-tag-success">
                            #è®¡ç®—æœº
                        </a>
                                
                        </div>
                        
                                <div class="post-content">
                                    <p>åœ¨å•ä½“åº”ç”¨ä¸­, æˆ‘ä»¬å¯ä»¥é€šè¿‡ cookie + session, æˆ–è€… JSON web token, å°†è®¤è¯é€»è¾‘åœ¨å•ä½“åº”ç”¨ä¸­å®ç°, ç®€å•é«˜æ•ˆ, è¿˜ç‰¹åˆ«çœäº‹.</p>
<p>ç„¶è€Œè¿™å‡ å¹´éšç€æœåŠ¡åŒ–æ½®æµè¶Šæ¥è¶Šç«(æˆ‘è§‰å¾—è¿™æ˜¯å¿…ç„¶è¶‹åŠ¿, æƒ³æƒ³æˆ‘ä»¬äººç±»ç¤¾ä¼šæ˜¯å¦‚ä½•è¿ä½œçš„), å¾ˆå¤šä»¥å‰å•ä½“åº”ç”¨ä¸å­˜åœ¨çš„é—®é¢˜, ç°åœ¨å·²æˆä¸ºå¯¹å•ä½“åº”ç”¨æ‹†åˆ†è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªéšœç¢, æ¯”å¦‚ç³»ç»Ÿçš„è®¤è¯ä½“ç³».</p>
<p>å¦‚æœæ¯ä¸ªæ‹†å‡ºæ¥çš„æœåŠ¡éƒ½è¦åšä¸€æ¬¡è®¤è¯(å°±æ˜¯ç¨‹åºå‘˜å¤šå†™å‡ ä»½è®¤è¯çš„ä»£ç å•¦), å¯¹äºæœ‰ç†æƒ³æœ‰è¿½æ±‚çš„çµé­‚ã®ç å†œæ¥è¯´, æ˜¯ç»å¯¹æ— æ³•æ¥å—çš„.ä½ è¯´è®¤è¯ä»£ç copyå°±å¥½äº†, ä¸ç”¨é‡æ–°å†™.no no no, è¿™æ ·æå‡ºæ¥çš„æ¶æ„ä¸ä»…çœ‹ç€åˆ«æ‰­, ä»£ç é—»ç€å°±è§‰å¾—è‡­, è€Œä¸”è¿Ÿæ—©æœ‰ä¸€å¤©ä¼šå‡ºé—®é¢˜.</p>
<p>è§£å†³å•ä½“åº”ç”¨æ‹†åˆ†æœåŠ¡åçš„è®¤è¯é—®é¢˜å…¶å®å¾ˆå¸¸è§„, å›æƒ³ä¸‹ç¥–å¸ˆçˆ·ä»¬å¸®æˆ‘ä»¬æ€»ç»“çš„ä¸€å¥è¯: &quot;Any problem in computer science can be solved by another layer of indirection.&quot; æˆ‘ä»¬å¯ä»¥åœ¨æ‰€æœ‰æœåŠ¡å‰é¢å¢åŠ ä¸€å±‚è®¤è¯æœåŠ¡.</p>
<figure data-type="image" tabindex="1"><img src="http://upload-images.jianshu.io/upload_images/1244770-7c58571258714b45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></figure>
<p>çœ‹åˆ°è®¤è¯æœåŠ¡è¿™ä¸€å±‚ç”¨æ¥ä½œä¸ºç”¨æˆ·è¯·æ±‚çš„æ€»å…¥å£, æœ‰Nginxæˆ–è€…Apacheä½¿ç”¨ç»éªŒçš„åŒå­¦è‡ªç„¶è€Œç„¶å°±æƒ³åˆ°å®ƒä»¬. å¦‚æœèƒ½æŠŠè®¤è¯æ¨¡å—çš„åŠŸèƒ½æ•´åˆè¿›Nginxæˆ–è€…Apacheè¿™äº›WebæœåŠ¡å™¨, é‚£å²‚ä¸æ˜¯æ›´å®Œç¾ ?</p>
<p>è€Œè¿™ç¯‡æ–‡ç« çš„ä¸»è§’: Openresty,å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®€å•å¿«é€Ÿå¾—å®Œæˆè¿™ä¸ªæƒ³æ³•.è¿™æ˜¯ä¸€ä¸ªç”±<a href="https://github.com/agentzh">æ˜¥å“¥(Github)</a>å‘èµ·çš„é¡¹ç›®.ä½ å¯ä»¥å°†Openrestyçœ‹åšNginx + å¸¸ç”¨æ¨¡å—æ„æˆçš„è½¯ä»¶åŒ…, ä½†æ˜¯æœ€é‡è¦çš„åŠŸèƒ½æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Luaåœ¨Nginxå®ç°Webæ¡†æ¶æ‰èƒ½å®ç°çš„é€»è¾‘, æ¥ä¸‹æ¥æ–‡ç« å°†ä¼šå¼€å§‹ä»‹ç»å¦‚ä½•ä½¿ç”¨Openresty, å°†ä¸Šé¢æåˆ°çš„è®¤è¯æœåŠ¡æ•´åˆè¿›Nginxé‡Œ.</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>Openrestyæœ‰ä¸¤ç§å®‰è£…æ–¹å¼, ä¸€ç§æ˜¯ä½¿ç”¨æºç ç¼–è¯‘å®‰è£….ä¸€ç§ä½¿ç”¨å®˜æ–¹æä¾›çš„é¢„ç¼–è¯‘åŒ…:<br>
å…·ä½“å¯å‚è€ƒå®˜ç½‘çš„<a href="https://openresty.org/cn/linux-packages.html">å®‰è£…æ–‡æ¡£</a></p>
<h2 id="hello-world">Hello world</h2>
<p>å¦‚æœä½ æ²¡ä¿®æ”¹è¿‡Openrestyçš„å®‰è£…ä½ç½®, é»˜è®¤ä¼šè¢«å®‰è£…åœ¨/use/local/openrestyç›®å½•ä¸‹.æˆ‘ä»¬ç°åœ¨å¯ä»¥å°è¯•å†™ä¸€ä¸ªHello worldçº§åˆ«çš„demo.</p>
<p>ä¸ºOpenrestyåˆ›å»ºå·¥ä½œç›®å½•å¹¶åˆ›å»ºé…ç½®æ–‡ä»¶:</p>
<blockquote>
<p>mkdir ~/openresty_work<br>
cd ~/openresty_work<br>
touch nginx.conf</p>
</blockquote>
<p>æ¥ä¸‹æ¥åœ¨nginx.confé‡Œé¢é…ç½®ä¸€ä¸ªè·¯ç”±è§„åˆ™</p>
<pre><code>worker_processes 1;
error_log logs/error.log;

events {
	worker_connections 1024;
}

http {
	server {
		listen 8080;
		location /hello {
			default_type text/html;
			content_by_lua_block {
				ngx.say(&quot;Hello Openresty.&quot;)
			}			
		}
	}
}

</code></pre>
<p>è·Ÿæ™®é€šçš„Nginxé…ç½®æ–‡ä»¶æ¯”èµ·æ¥, ä¸Šé¢çš„é…ç½®å¤šäº†ä¸€ä¸ªcontent_by_lua_blockæŒ‡ä»¤, æ­£æ˜¯é€šè¿‡è°ƒç”¨è¯¥æŒ‡ä»¤, è®¿é—®è¯¥è·¯ç”±çš„æ—¶å€™,æ‰ä¼šè¾“å‡ºç›¸åº”çš„å†…å®¹.è¿™ä¸ªæŒ‡ä»¤æ˜¯ç”±Openrestyä¸­çš„<a href="http://openresty.org/cn/lua-nginx-module.html">LuaNginxModule</a>æ¨¡å—æä¾›çš„åŠŸèƒ½, è¯·æ±‚è¿›æ¥çš„æ—¶å€™, Nginxä¼šå¯åŠ¨luaçš„è™šæ‹Ÿæœº, è¾“å‡ºçš„å†…å®¹åˆ™ç”±luaæä¾›.</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>content_by_lua_file</code>æŒ‡ä»¤æ›¿ä»£<code>content_by_lua_block</code>, å°†ç›¸å…³çš„luaä»£ç å†™è¿›æ–‡ä»¶é‡Œ.</p>
<pre><code>location /hello {
			content_by_lua_file lua/hello.lua;
		}

</code></pre>
<pre><code class="language-lua">--- hello.lua
ngx.say(&quot;Hello Openresty.&quot;)
</code></pre>
<p>æœ‰äº†ä¸Šé¢çš„é“ºå«,æ¥ä¸‹æ¥å¯ä»¥å¼€å§‹æ„å»ºæˆ‘ä»¬çš„è®¤è¯æœåŠ¡,è®¤è¯çš„æ–¹å¼ä½¿ç”¨<a href="https://jwt.io/">JWT</a></p>
<p>Openrestyå°†ä¸€ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä¸º4ä¸ªé˜¶æ®µ:</p>
<figure data-type="image" tabindex="2"><img src="http://upload-images.jianshu.io/upload_images/1244770-7854b722bc3cf62c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></figure>
<p>æˆ‘ä»¬çš„è®¤è¯æœåŠ¡å°†ä¼šæŒ‚è½½åœ¨ç¬¬äºŒé˜¶æ®µ, å³ Rewrite/Access Phase ä¸Š.</p>
<p>æ¥ä¸‹æ¥å‡†å¤‡ä¸€ä¸ªéœ€è¦ç”¨åˆ°çš„åº“:<br>
<a href="https://github.com/SkyLothar/lua-resty-jwt">lua-resty-jwt</a><br>
cloneä¸‹æ¥åæ”¾åˆ°hello.luaæ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹,å¹¶å°†lua_package_pathé…ç½®ä¸º:</p>
<pre><code>lua_package_path &quot;/root/openresty_work/lua/?.lua;/root/openresty_work/lua/lua-resty-jwt/lib/?.lua;;&quot;;
</code></pre>
<p>æ„å»ºçš„æ€è·¯ä¹Ÿå¾ˆç®€å•, å¯¹ç”¨æˆ·æä¾›ä¸€ä¸ªç™»å½•è¯·æ±‚, éªŒè¯èº«ä»½åå°†jwt tokenåˆ†å‘ç»™ç”¨æˆ·.ç”¨æˆ·æ¥ä¸‹æ¥è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£, åˆ™åœ¨headeré‡Œé¢åŠ å…¥è¯¥token, è¯·æ±‚è¿›å…¥Openrestyåç”±luaæå–å‡ºtokenè¿›è¡Œè®¤è¯.</p>
<p>Nginxé…ç½®æ–‡ä»¶</p>
<pre><code>server {
                listen 8080;
                location /hello {
                        content_by_lua_file lua/hello.lua;
                }
                location /login {
                        content_by_lua_file lua/sign.lua;
                }
                location /service1 {
                        access_by_lua_file lua/verify.lua;
                        # éœ€è¦åå‘ä»£ç†åœ¨è¿™é…ç½®
                }
                location /service {
                        access_by_lua_file lua/verify.lua;
                        # ...
                }
        }

</code></pre>
<p>ä¸‹é¢æ˜¯é…ç½®ä¸­ç›¸å…³çš„luaæ–‡ä»¶<br>
sign.lua â†“:</p>
<pre><code class="language-lua">local jwt = require 'resty.jwt'

-- åªå…è®¸POSTè¯·æ±‚
if ngx.req.get_method() ~= 'POST' then
    ngx.status = 405
    ngx.say(&quot;Mehtod Not Allow&quot;)
    return
end

-- è·å–è¯·æ±‚body
ngx.req.read_body()
local body_raw = ngx.req.get_body_data()
local body_json = cjson.decode(body_raw)
local username = body_json['username']
local password = body_json['password']

if not username or not password then
    ngx.log(ngx.ERR, username, password)
    ngx.status = 400
    ngx.say('æ— æ³•è·å–è´¦å·æˆ–è€…å¯†ç ')
    return
end

-- éªŒè¯è´¦å·å’Œå¯†ç æ˜¯å¦æ­£ç¡®,å¦‚æœéªŒè¯å¤±è´¥åˆ™åšå¦‚ä¸‹å¤„ç†
if not this_is_a_auth_method(username, password) then
    ngx.status = 401
    ngx.say('è®¤è¯å¤±è´¥')
    return
end
</code></pre>
<p>verify.lua â†“:</p>
<pre><code>local jwt = require 'resty.jwt'

-- ä»è¯·æ±‚ä¸­æå–headerå¹¶ä»headerä»è·å–tokenå­—æ®µ
local headers = ngx.req.get_headers()
local token = headers['token']

-- æ£€æŸ¥tokenæ˜¯å¦å­˜åœ¨
if not token then 
    ngx.status = 400
    ngx.say('æ— æ³•è·å–token')
    return 
end 

-- éªŒè¯token
local jwt_obj = jwt:verify(vars.jwt_salt(), token)
if not jwt_obj['verified'] then 
    ngx.status = 401
    ngx.say('æ— æ•ˆçš„token')
    return 
end 
</code></pre>
<p>è‡³æ­¤ä¸€ä¸ªä½¿ç”¨Openrestyæ„å»ºçš„è®¤è¯ç½‘å…³çš„é›å½¢å·²ç»å‡ºæ¥äº†.éœ€è¦è¯´æ˜çš„ä¸€å¥æ˜¯, ä¸Šé¢çš„ä»£ç ç”±äºæ²¡æœ‰å…¬å¸ç›¸å…³çš„è¿è¡Œç¯å¢ƒ,ç¬”è€…æ²¡æœ‰ç»è¿‡æµ‹è¯•å’ŒéªŒè¯.æ‰€ä»¥åªå¯é˜…è¯»,ä¸å¯å¤åˆ¶åç›´æ¥è¿è¡Œ ğŸ˜ƒ</p>
<p>å¦‚æœæƒ³æŠŠè¿™å¥—è®¤è¯ç½‘å…³ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸Š, è¿˜æœ‰å¾ˆå¤šä¸œè¥¿éœ€è¦è€ƒè™‘.æ¯”å¦‚è·¨åŸŸé—®é¢˜, é™æ€æ–‡ä»¶çš„ä»£ç†é—®é¢˜ç­‰ç­‰.</p>
<p>ä¸ªäººæ¥è§¦Openrestyçš„æ—¶é—´ä¹Ÿä¸é•¿, æ–‡ä¸­éš¾å…ä¼šæœ‰åœ°æ–¹å†™é”™äº†æˆ–è€…è¡¨è¾¾å¾—å¾ˆå·®, æ¬¢è¿å‘è¯„è®ºæˆ–è€…å‘é‚®ä»¶ç»™æˆ‘æŒ‡æ­£: lwhile521@gmail.com ,æ„Ÿè°¢.</p>
<p>å¯¹äºOpenresty, ä¸ªäººè®¤ä¸ºè¦å¯¹å®ƒäº§ç”Ÿå…´è¶£,å…³é”®åœ¨äºè®¤ä¸è®¤å¯è®©Nginxæ‰¿æ‹…é™¤äº†WebæœåŠ¡å™¨ä¹‹å¤–æ›´å¤šçš„ä¸šåŠ¡, å¯¹äºOpenresty, å®ƒèƒ½å¸¦æ¥çš„å¥½å¤„æœ‰:</p>
<ol>
<li>
<p>æè‡´çš„æ€§èƒ½.ä¸Šæ–‡æ²¡æœ‰æåˆ°Openrestyçš„æ€§èƒ½, å…¶å®Openrestyçš„ç¼–ç¨‹æ¨¡å‹å’ŒNodeJSå¾ˆåƒ, åœ¨Openrestyçš„ä¸–ç•Œé‡Œé¢,æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯éé˜»å¡çš„,æ›´éš¾å¾—å¯è´µçš„æ˜¯, å®ƒä¸éœ€è¦ä½¿ç”¨NodeJSä¸­çš„å›è°ƒå‡½æ•°, ä»£ç å†™èµ·æ¥å…¶å®è¿˜æ˜¯åŒæ­¥æ¨¡å‹, é…åˆCè¯­è¨€ç¼–å†™çš„Nginx, æœ€å¿«çš„è„šæœ¬è¯­è¨€lua+luajitè§£é‡Šå™¨,è¿™å¥—æ–¹æ¡ˆçš„æ€§èƒ½æ— å¯æŒ‘å‰”äº†.</p>
</li>
<li>
<p>é™ä½äº†Nginxæ¨¡å—çš„å¼€å‘éš¾åº¦. Nginx + C/C++èƒ½åšçš„, Openrestyç”¨luaéƒ½èƒ½åš.å¼€å‘æ•ˆç‡é«˜äº†, æ€§èƒ½è¿˜ä¸æ€ä¹ˆé™, ä½•ä¹è€Œä¸ä¸ºå‘¢?</p>
</li>
</ol>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<blockquote>
<ol>
<li><a href="https://www.gitbook.com/book/moonbingbing/openresty-best-practices">Openrestyæœ€ä½³å®è·µ</a></li>
<li><a href="https://github.com/SkyLothar/lua-resty-jwt">lua-resty-jwt</a></li>
</ol>
</blockquote>

                                </div>
                    </article>
                    <!--  -->
                    
                        <div class="next-post">
                            <div class="next">ä¸‹ä¸€ç¯‡</div>
                            <a href="lwhile.github.io/post/ri-zhi-qie-fen-wen-ti-you-gan">
                                <h3 class="post-title">
                                    æ—¥å¿—åˆ‡åˆ†é—®é¢˜æœ‰æ„Ÿ
                                </h3>
                            </a>
                        </div>
                        
                            <div id="disqus_thread"></div>
                            <div id="gitalk-container"></div>
                </div>
                <!-- middle -->
                <div class="main-container-middle"></div>
                <!-- right -->
                <div id="sidebar" class="main-container-right">
                    
                        <!-- toc -->
                        
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">ç›®å½•</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85">å®‰è£…</a></li>
<li><a href="#hello-world">Hello world</a>
<ul>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*è·å–æ–‡ç« ç›®å½•é›†åˆ,å¯é€šè¿‡:headerè¿‡æ»¤å™¨*/
                var alis = $('.post-content :header');
                /*è·å–ä¾§è¾¹æ ç›®å½•åˆ—è¡¨é›†åˆ**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*è·å–æ»šåŠ¨æ¡åˆ°é¡¶éƒ¨çš„è·ç¦»*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*è·å–é”šç‚¹é›†åˆä¸­çš„å…ƒç´ åˆ†åˆ«åˆ°é¡¶ç‚¹çš„è·ç¦»*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*é«˜äº®æ˜¾ç¤º*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*ç»‘å®šæ»šåŠ¨äº‹ä»¶ */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                            

                </div>




            </div>


            <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="lwhile.github.io/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>


    </div>
    <script>
        $('#sidebar').stickySidebar({
            topSpacing: 80,
            // bottomSpacing: 60
        });
    </script>
    
</body>

</html>